parameters:
  keycloak:
    multi_instance: true
    namespace: syn-${_instance}
    release_name: keycloak
    charts:
      keycloak: '10.3.1'
    # FQDN should be overwritten on the cluster level
    fqdn: keycloak.example.com
    # Keycloak Admin
    admin:
      secretname: keycloak-admin-user
      username: admin
      password: '?{vaultkv:${customer:name}/${cluster:name}/${_instance}/admin-password}'
    # Replica count
    replicas: 2
    # Ingress or Route should be enabled on the distribution level
    ingress:
      enabled: false
      annotations: {}
      secretName: ${keycloak:fqdn}
    route:
      enabled: false
    # Labels can be extended in the config hierarchy by providing further
    # entries in key `labels`.
    labels:
      app.kubernetes.io/name: keycloak
      app.kubernetes.io/instance: ${_instance}
      app.kubernetes.io/version: v11.0.0
      app.kubernetes.io/component: keycloak
      app.kubernetes.io/managed-by: commodore
    # Pod resource requests and limits
    resources:
      requests:
        memory: "512Mi"
        cpu: "500m"
      limits:
        memory: "1Gi"
        cpu: "1"
    # Extra java opts are appended to the default options set in
    # `class/keycloak.yml`.
    extraJavaOpts: ""
    # Enable ServiceMonitor, PrometheusRule, and all Keycloak statistics on
    # the metrics endpoint by default.
    monitoring:
      enabled: true
      statistics: all
      rules: []
    # Use Bitnami Postgres installed by the Keycloak chart by default
    database:
      provider: builtin

      secretname: keycloak-postgresql
      password: '?{vaultkv:${customer:name}/${cluster:name}/${_instance}/db-password}'
      database: keycloak
      username: keycloak

      # For provider=external
      external:
        vendor: postgres
        host: postgres.example.com
        port: 5432

      # For provider=builtin
      builtin:
        enabled: true

    helm_values:
      image:
        repository: quay.io/keycloak/keycloak
      replicas: ${keycloak:replicas}
      statefulsetLabels: ${keycloak:labels}
      resources: ${keycloak:resources}
      # extraEnv *MUST* be a string, as it's fed through a templating
      # function.
      extraEnv: |
        - name: JAVA_OPTS
          value: >-
                    -XX:+UseContainerSupport
                    -XX:MaxRAMPercentage=50.0
                    -Djava.net.preferIPv4Stack=true
                    -Djboss.modules.system.pkgs=$JBOSS_MODULES_SYSTEM_PKGS
                    -Djava.awt.headless=true
                    ${keycloak:extraJavaOpts}
        - name: KEYCLOAK_STATISTICS
          value: ${keycloak:monitoring:statistics}
        - name: JGROUPS_DISCOVERY_PROTOCOL
          value: dns.DNS_PING
        - name: JGROUPS_DISCOVERY_PROPERTIES
          value: 'dns_query={{ include "keycloak.serviceDnsName" . }}'
        - name: CACHE_OWNERS_COUNT
          value: "${keycloak:helm_values:replicas}"
        - name: CACHE_OWNERS_AUTH_SESSIONS_COUNT
          value: "${keycloak:helm_values:replicas}"
        - name: PROXY_ADDRESS_FORWARDING
          value: "true"
      extraEnvFrom: |
        - secretRef:
            name: ${keycloak:admin:secretname}
        - secretRef:
            name: ${keycloak:database:secretname}
      serviceAccount:
        labels: ${keycloak:labels}
      ingress:
        enabled: ${keycloak:ingress:enabled}
        annotations: ${keycloak:ingress:annotations}
        labels: ${keycloak:labels}
        rules:
          - host: ${keycloak:fqdn}
            paths: ["/"]
        tls:
          - hosts:
              - ${keycloak:fqdn}
            secretName: ${keycloak:ingress:secretName}
      route:
        enabled: ${keycloak:route:enabled}
        labels: ${keycloak:labels}
        host: ${keycloak:fqdn}
      service:
        labels: ${keycloak:labels}
      serviceMonitor:
        enabled: ${keycloak:monitoring:enabled}
        labels: ${keycloak:labels}
      prometheusRule:
        enabled: ${keycloak:monitoring:enabled}
        labels: ${keycloak:labels}
        rules: ${keycloak:monitoring:rules}
      postgresql:
        enabled: ${keycloak:database:builtin:enabled}
        existingSecret: ${keycloak:database:secretname}
        image:
          registry: quay.io
        master:
          labels: ${keycloak:labels}
